<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>회원 상세 정보</title>
</head>
<body>
<header>
    <h1>회원 상세 정보</h1>
    <nav>
        <a href="/admin/user">회원 검색</a>
    </nav>
</header>

<section class="user-detail">
    <h2>회원 정보</h2>
    <div>
        <p><strong>닉네임:</strong> <span th:text="${user.nickname}"></span></p>
        <p><strong>이메일:</strong> <span th:text="${user.email}"></span></p>
        <p><strong>포인트:</strong> <span th:text="${user.point}"></span></p>
        <p><strong>설명:</strong> <span th:text="${user.description}"></span></p>
        <p><strong>최근 활동일:</strong> <span th:text="${user.lastActivityDate}"></span></p>
        <p><strong>활성화 여부:</strong> <span th:text="${user.activated ? '활성화됨' : '비활성화됨'}"></span></p>
        <p><strong>가입일:</strong> <span th:text="${user.createdAt}"></span></p>
        <p><strong>최종 수정일:</strong> <span th:text="${user.updatedAt}"></span></p>
    </div>

    <h3>포인트 및 활성화 상태 수정하기</h3>
    <form action="/admin/users/update" method="post">
        <input type="hidden" name="userId" th:value="${user.id}">
        <label for="newPoint">포인트</label>
        <input type="number" id="newPoint" name="point" value="${user.point}" required>

        <label for="activated">활성화 여부</label>
        <select id="activated" name="activated">
            <option th:value="true" th:text="'활성화'" th:selected="${user.activated}"></option>
            <option th:value="false" th:text="'비활성화'" th:selected="${user.activated == false}"></option>
        </select>

        <button type="submit">수정</button>
    </form>

    <!-- 현재 유저의 역할 목록 표시 -->
    <div>
        <h3>현재 보유한 역할</h3>
        <ul>
            <li th:each="roleMapping : ${user.userRoleMappings}">
                <span th:text="${roleMapping.role.description}"></span>
            </li>
        </ul>
    </div>

    <h3>새롭게 변경할 역할 </h3>
    <form id="updateRole">
        <input type="hidden" name="userId" th:value="${user.id}">
        <div style="display: flex; gap : 3px;">
            <label th:each="one : ${roles}" style="display: inline-block">
                <input type="checkbox" th:value="${one.role.name()}" name="role"/>
                <span th:text="${one.description }"></span>
            </label>

        </div>
        <button type="submit">역할 추가</button>
    </form>


    <div th:if="${error}">
        <p style="color: red;" th:text="${error}"></p>
    </div>
</section>
<script>
    document.querySelector("#updateRole").addEventListener("submit", evt => {
        evt.preventDefault();
        const userId = evt.target.querySelector('input[name="userId"]').value; // userId 값 추출

        // 체크된 role 값들 추출
        const selectedRoles = Array.from(evt.target.querySelectorAll('input[name="role"]:checked'))
            .map(checkbox => checkbox.value);

        if (selectedRoles.length === 0) {
            return alert("하나 이상의 역할은 반드시 부여되어야 합니다.");
        }

        fetch("/api/admin/users/roles", {
            method: "PUT",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({userId: userId, roles: selectedRoles})
        }).then(response => {
            if (response.ok) {
                alert("사용자에게 새 역할이 설정되었습니다.");
                location.reload();
            } else {
                throw new Error("Error updating roles");
            }
        })
    });


</script>
</body>
</html>

    <div th:if="${error}">
        <p style="color: red;" th:text="${error}"></p>
    </div>
</section>
</body>
</html>
